upstream wekan {
    # Path to Puma SOCK file, as defined previously
    # NodeJS Express Etc ANything with custom port localhost:8080 localhost:3000 etc
    server 127.0.0.1:4000 fail_timeout=0;
    # Ruby Puma Sample:
    # server unix:///home/zeus/_/work/velophil/projects/wekan/sockets/puma.sock fail_timeout=0;
}
server {
    listen 80 http2;
    listen  443 ssl http2;
    listen [::]:443 ssl http2;

	if ($scheme = http) {
  	    rewrite ^ https://$host$request_uri? permanent;
	}

    underscores_in_headers on;
    server_name wekan.test www.wekan.test *.wekan.test;
    charset utf-8;
    proxy_buffer_size          128k;
    proxy_buffers              4 256k;
    proxy_busy_buffers_size    256k;

    root /home/zeus/_/work/velophil/projects/wekan/public;
	ssl_protocols TLSv1.2;
	ssl_prefer_server_ciphers on;
	ssl_ciphers EECDH+AESGCM:EECDH+CHACHA20:EECDH+AES;

	ssl_session_cache shared:SSL:10m;
	ssl_session_timeout 10m;

	ssl_ecdh_curve sect571r1:secp521r1:brainpoolP512r1:secp384r1;
	add_header Strict-Transport-Security "max-age=31536000; preload";

        # Add headers to serve security related headers
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Robots-Tag none;
        add_header X-Download-Options noopen;
        add_header X-Permitted-Cross-Domain-Policies none;

	add_header Referrer-Policy "same-origin";

        client_max_body_size 10G; # 0=unlimited - set max upload size
        fastcgi_buffers 64 4K;

        # gzip off;

    # Additional rules go here.
    # ssl on;   [warn] the "ssl" directive is deprecated, use the "listen ... ssl"
    ssl_certificate /home/zeus/.valet/Certificates/wekan.test.crt;
    ssl_certificate_key /home/zeus/.valet/Certificates/wekan.test.key;
    gzip on;
    gzip_vary on;
    gzip_comp_level 4;
    gzip_min_length 256;
    gzip_proxied expired no-cache no-store private no_last_modified no_etag auth;
    gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;

    # ssl_session_timeout  5m;

    # Uncomment error pages one you place make them accesible
    # error_page 500 502 503 504 /500.html;
    # Place generated invidual cases here too
    # --
    # here
    location = /favicon.ico {
        access_log off; log_not_found off;
        alias /home/zeus/_/work/velophil/projects/wekan/public/favicon.ico;
    }
    # ---
    try_files $uri/index.html $uri @wekan;
    location @wekan {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' "$origin_is_allowed";
            # add_header 'Access-Control-Allow-Origin' '*';
            # add_header 'Access-Control-Allow-Origin' 'https://titra.test';
            # add_header 'Access-Control-Allow-Credentials' 'True';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            #
            # Custom headers and headers various browsers *should* be OK with but aren't
            #
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
            #
            # Tell client that this pre-flight info is valid for 20 days
            #
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
        # if ($request_method = 'POST') {
        #     add_header 'Access-Control-Allow-Origin' "$origin_is_allowed";
        #     # add_header 'Access-Control-Allow-Origin' '*';
        #     # add_header 'Access-Control-Allow-Origin' 'https://titra.test';
        #     # add_header 'Access-Control-Allow-Credentials' 'True';
        #     add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        #     add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        #     add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
        # }
        # if ($request_method = 'GET') {
        #     add_header 'Access-Control-Allow-Origin' "$origin_is_allowed";
        #     # add_header 'Access-Control-Allow-Origin' '*';
        #     # add_header 'Access-Control-Allow-Origin' 'https://titra.test';
        #     # add_header 'Access-Control-Allow-Credentials' 'True';
        #     add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        #     add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        #     add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
        # }
        # if ($allow_origin = 'allowed') {
        #     add_header 'Access-Control-Allow-Origin' "$origin_is_allowed";
        #     add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
        #     add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range';
        #     add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range';
        #     add_header Content-Type "application/json; charset=utf-8";
        #     # proxy_pass http://localhost:7777/api/$capture;
        # }
        # if ($allow_origin = 'blocked') {
        #     add_header Content-Type "text/plain";
        #     return 403 "Your domain is not allowed!";
        # }
        # proxy_pass http://wekan;
        # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # proxy_set_header Host $http_host;
        # proxy_set_header X-Forwarded-Proto https;
        # proxy_redirect off;

        proxy_pass http://wekan;
        proxy_redirect http://wekan http://$http_host;
        proxy_read_timeout 300;

        proxy_set_header Proxy '';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Credentials;

        set $CORS_CREDS true;
        set $CORS_ORIGIN $http_origin;
        set $CORS_METHODS 'GET, POST, PUT, DELETE, OPTIONS';
        set $CORS_HEADERS 'Authentication-Token, Cache-Control, Cookie, If-Modified-Since, Range, User-Agent, X-Requested-With';
        # FYI: Always allowed headers: Accept, Accept-Language, Content-Language, Content-Type
        set $CORS_EXPOSE_HEADERS 'Content-Disposition, Content-Length, Content-Range, Set-Cookie';
        # FYI: Always exposed headers: Cache-Control, Content-Language, Content-Type, Expires, Last-Modified, Pragma
        set $CORS_PREFLIGHT_CACHE_AGE 600;
        set $X_FRAME_OPTIONS '';
        # set $X_FRAME_OPTIONS "ALLOW FROM $http_origin";
        # proxy_set_header Access-Control-Allow-Origin $CORS_ORIGIN;
        # proxy_set_header Access-Control-Allow-Origin '127.0.0.1:3005';
        # proxy_set_header Access-Control-Allow-Credentials 'True';
        # add_header Access-Control-Allow-Origin '127.0.0.1:3005';

        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin $CORS_ORIGIN;
            add_header Access-Control-Allow-Methods $CORS_METHODS;
            add_header Access-Control-Allow-Headers $CORS_HEADERS;
            add_header Access-Control-Allow-Credentials $CORS_CREDS;

            add_header Access-Control-Max-Age $CORS_PREFLIGHT_CACHE_AGE;
            add_header Content-Type 'text/plain; charset=utf-8';
            add_header Content-Length 0;
            return 204;
        }
        if ($request_method != 'OPTIONS') {
            add_header Access-Control-Allow-Origin $CORS_ORIGIN;
            add_header Access-Control-Allow-Methods $CORS_METHODS;
            add_header Access-Control-Allow-Headers $CORS_HEADERS;
            add_header Access-Control-Allow-Credentials $CORS_CREDS;

            add_header Access-Control-Expose-Headers $CORS_EXPOSE_HEADERS;
            add_header X-Frame-Options $X_FRAME_OPTIONS;
        }
    }
    # client_max_body_size 4G;
    keepalive_timeout 10;
}



# server {
#     listen 80;
#     server_name wekan.test www.wekan.test *.wekan.test;
#     return 301 https://$host$request_uri;
# }

# server {
#     listen 443 ssl http2;
#     server_name wekan.test www.wekan.test *.wekan.test;
#     root /;
#     charset utf-8;

#     location /41c270e4-5535-4daa-b23e-c269744c2f45/ {
#         internal;
#         alias /;
#         try_files $uri $uri/;
#     }

#     ssl_certificate /home/zeus/.valet/Certificates/wekan.test.crt;
#     ssl_certificate_key /home/zeus/.valet/Certificates/wekan.test.key;

#     location / {
#         rewrite ^ /home/zeus/.config/composer/vendor/cpriego/valet-linux/server.php last;
#     }

#     location = /favicon.ico { access_log off; log_not_found off; }
#     location = /robots.txt  { access_log off; log_not_found off; }

#     access_log off;
#     error_log /home/zeus/.valet/Log/nginx-error.log;

#     error_page 404 /home/zeus/.config/composer/vendor/cpriego/valet-linux/server.php;

#     location ~ \.php$ {
#         fastcgi_buffering off;
#         fastcgi_split_path_info ^(.+\.php)(/.+)$;
#         fastcgi_pass unix:/home/zeus/.valet/valet.sock;
#         fastcgi_index /home/zeus/.config/composer/vendor/cpriego/valet-linux/server.php;
#         include fastcgi_params;
#         fastcgi_param SCRIPT_FILENAME /home/zeus/.config/composer/vendor/cpriego/valet-linux/server.php;
#     }

#     location ~ /\.ht {
#         deny all;
#     }
# }

# server {
#     listen 88;
#     server_name wekan.test www.wekan.test *.wekan.test;
#     root /;
#     charset utf-8;
#     client_max_body_size 128M;

#     location /41c270e4-5535-4daa-b23e-c269744c2f45/ {
#         internal;
#         alias /;
#         try_files $uri $uri/;
#     }

#     location / {
#         rewrite ^ /home/zeus/.config/composer/vendor/cpriego/valet-linux/server.php last;
#     }

#     access_log off;
#     error_log /home/zeus/.valet/Log/nginx-error.log;

#     error_page 404 /home/zeus/.config/composer/vendor/cpriego/valet-linux/server.php;

#     location ~ \.php$ {
#         fastcgi_buffering off;
#         fastcgi_split_path_info ^(.+\.php)(/.+)$;
#         fastcgi_pass unix:/home/zeus/.valet/valet.sock;
#         fastcgi_index /home/zeus/.config/composer/vendor/cpriego/valet-linux/server.php;
#         include fastcgi_params;
#         fastcgi_param SCRIPT_FILENAME /home/zeus/.config/composer/vendor/cpriego/valet-linux/server.php;
#     }

#     location ~ /\.ht {
#         deny all;
#     }
# }

